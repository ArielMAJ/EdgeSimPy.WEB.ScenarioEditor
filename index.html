<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EdgeSimPy Scenario Editor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .actions {
      display: flex;
      gap: 15px;
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      padding: 8px 16px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
      padding: 8px 16px;
      font-size: 12px;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .section-header {
      background: #f8f9fa;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .section-header:hover {
      background: #e9ecef;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1.2em;
      color: #1f2937;
    }

    .section-count {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
    }

    .section-body {
      padding: 20px;
      display: none;
    }

    .section.expanded .section-body {
      display: block;
    }

    .section.expanded .toggle-icon {
      transform: rotate(90deg);
    }

    .toggle-icon {
      transition: transform 0.3s;
      font-size: 1.2em;
      color: #667eea;
    }

    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .item-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background: #fafafa;
      transition: all 0.2s;
    }

    .item-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .item-id {
      font-weight: 600;
      color: #667eea;
      font-size: 1.1em;
    }

    .item-actions {
      display: flex;
      gap: 5px;
    }

    .item-details {
      font-size: 0.9em;
      color: #6b7280;
      line-height: 1.6;
    }

    .item-details div {
      margin-bottom: 5px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 800px;
      margin: 40px auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 20px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .modal-header h2 {
      font-size: 1.5em;
      flex: 1;
      min-width: 200px;
    }

    .view-toggle {
      display: flex;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 4px;
      gap: 4px;
    }

    .view-toggle button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .view-toggle button.active {
      background: white;
      color: #667eea;
      font-weight: 600;
    }

    .view-toggle button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
      padding: 30px;
      max-height: 70vh;
      overflow-y: auto;
      background: #fafafa;
    }

    .modal-body::-webkit-scrollbar {
      width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      font-family: 'Courier New', monospace;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .view-container {
      display: none;
    }

    .view-container.active {
      display: block;
    }

    .form-view {
      display: grid;
      gap: 20px;
    }

    .form-help {
      background: #eff6ff;
      border-left: 4px solid #667eea;
      padding: 12px 16px;
      border-radius: 6px;
      color: #1e40af;
      font-size: 0.9em;
      margin-bottom: 20px;
    }

    .field-group {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .field-group-title {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
      align-items: start;
      margin-bottom: 10px;
    }

    .field-row:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-weight: 500;
      color: #374151;
      padding-top: 10px;
    }

    .field-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .field-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .array-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .array-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .array-item input {
      flex: 1;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add {
      background: #10b981;
      color: white;
      margin-top: 8px;
    }

    .btn-add:hover {
      background: #059669;
    }

    .btn-remove {
      background: #ef4444;
      color: white;
      min-width: 32px;
    }

    .btn-remove:hover {
      background: #dc2626;
    }

    .object-field {
      background: white;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    .nested-field {
      margin-left: 15px;
      padding-left: 15px;
      border-left: 2px solid #667eea;
    }

    .modal-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-radius: 0 0 12px 12px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .search-box {
      padding: 10px 15px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      flex: 1;
      min-width: 200px;
    }

    .search-box:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .nested-container {
      border: 1px solid #d1d5db;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .nested-header {
      padding: 12px;
      background: #e9ecef;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: #374151;
      user-select: none;
    }

    .nested-header:hover {
      background: #dee2e6;
    }

    .nested-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      padding: 0;
    }

    .nested-body.expanded {
      padding: 12px;
      background: #f9fafb;
    }

    .toggle-chevron {
      display: inline-block;
      transition: transform 0.2s;
      color: #667eea;
      min-width: 20px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>EdgeSimPy Scenario Editor</h1>
      <p>Create and edit EdgeSimPy simulation scenarios with ease</p>
    </div>

    <div class="actions">
      <input type="file" id="fileInput" accept=".json" style="display: none;">
      <button class="btn btn-primary" onclick="loadFromURL()">
        üì• Load Example JSON
      </button>
      <button class="btn btn-primary" onclick="loadFromCustomURL()">
        üîó Load from URL
      </button>
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
        üìÇ Upload JSON
      </button>
      <button class="btn btn-success" onclick="downloadJSON()">
        üíæ Download Scenario
      </button>
      <input type="text" class="search-box" id="searchBox" placeholder="Search by ID or component type...">
    </div>

    <div class="content" id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Click "Load Example JSON" to load the default EdgeSimPy scenario or "Load from URL" to load from a custom URL
        </p>
        <p style="font-size: 0.9em; color: #9ca3af; margin-top: 10px;">
          Note: Infinity values will be converted to 9007199254740991 (max safe integer)
        </p>
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Edit Item</h2>
        <div class="view-toggle">
          <button class="active" onclick="switchView('form')">üìù Form</button>
          <button onclick="switchView('json')">{ } JSON</button>
        </div>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div id="formView" class="view-container active"></div>
        <div id="jsonView" class="view-container"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveItem()">Save</button>
      </div>
    </div>
  </div>

  <script>
    let data = {};
    let currentEdit = { type: null, index: null };
    let currentEditData = null;

    const DEFAULT_URL = 'https://raw.githubusercontent.com/ArielMAJ/EdgeSimPy.API/refs/heads/test/test.json';

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const text = e.target.result.replace(/:\s*Infinity/g, ': 9007199254740991').replace(/\[\s*Infinity\s*\]/g, '[9007199254740991]');
            data = JSON.parse(text);
            renderUI();
            document.getElementById('fileInput').value = '';
          } catch (err) {
            alert('Invalid JSON file: ' + err.message);
            document.getElementById('fileInput').value = '';
          }
        };
        reader.readAsText(file);
      }
    });

    document.getElementById('searchBox').addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.section').forEach(section => {
        const type = section.dataset.type;
        const items = section.querySelectorAll('.item-card');
        let visibleCount = 0;

        items.forEach(item => {
          const text = item.textContent.toLowerCase();
          if (text.includes(query) || type.toLowerCase().includes(query)) {
            item.style.display = '';
            visibleCount++;
          } else {
            item.style.display = 'none';
          }
        });

        section.style.display = visibleCount > 0 || type.toLowerCase().includes(query) ? '' : 'none';
      });
    });

    async function loadFromURL() {
      try {
        const response = await fetch(DEFAULT_URL);
        const text = await response.text();
        const cleanedText = text.replace(/:\s*Infinity/g, ': 9007199254740991').replace(/\[\s*Infinity\s*\]/g, '[9007199254740991]');
        data = JSON.parse(cleanedText);
        renderUI();
      } catch (err) {
        alert('Failed to load JSON from URL: ' + err.message);
      }
    }

    async function loadFromCustomURL() {
      const url = prompt('Enter the URL to load JSON from:', '');
      if (!url) return; // User cancelled

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const text = await response.text();
        // Handle Infinity values in JSON - replace with max safe integer
        const cleanedText = text.replace(/:\s*Infinity/g, ': 9007199254740991').replace(/\[\s*Infinity\s*\]/g, '[9007199254740991]');
        data = JSON.parse(cleanedText);
        renderUI();
      } catch (err) {
        alert('Failed to load JSON from custom URL: ' + err.message);
      }
    }

    function renderUI() {
      const content = document.getElementById('content');
      content.innerHTML = '';

      Object.keys(data).forEach(type => {
        if (!Array.isArray(data[type])) return;

        const section = document.createElement('div');
        section.className = 'section';
        section.dataset.type = type;

        section.innerHTML = `
          <div class="section-header" onclick="toggleSection(this)">
            <div class="section-title">
              <span class="toggle-icon">‚ñ∂</span>
              <span>${type}</span>
              <span class="section-count">${data[type].length} items</span>
            </div>
            <button class="btn btn-success" onclick="event.stopPropagation(); addItem('${type}')">
              ‚ûï Add ${type}
            </button>
          </div>
          <div class="section-body">
            <div class="items-grid" id="${type}-items"></div>
          </div>
        `;

        content.appendChild(section);
        renderItems(type);
      });
    }

    function renderItems(type) {
      const container = document.getElementById(`${type}-items`);
      container.innerHTML = '';

      data[type].forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'item-card';

        const id = item.attributes?.id || item.id || idx;
        const details = getItemSummary(item, type);

        card.innerHTML = `
          <div class="item-header">
            <div class="item-id">#${id}</div>
            <div class="item-actions">
              <button class="btn btn-secondary" onclick="editItem('${type}', ${idx})">‚úèÔ∏è</button>
              <button class="btn btn-danger" onclick="deleteItem('${type}', ${idx})">üóëÔ∏è</button>
            </div>
          </div>
          <div class="item-details">${details}</div>
        `;

        container.appendChild(card);
      });
    }

    function getItemSummary(item, type) {
      const lines = [];

      if (item.attributes) {
        Object.keys(item.attributes).slice(0, 4).forEach(key => {
          let val = item.attributes[key];
          if (Array.isArray(val)) val = `[${val.length} items]`;
          else if (typeof val === 'object') val = '[object]';
          else if (String(val).length > 30) val = String(val).substring(0, 30) + '...';
          lines.push(`<div><strong>${key}:</strong> ${val}</div>`);
        });
      } else {
        Object.keys(item).slice(0, 4).forEach(key => {
          let val = item[key];
          if (Array.isArray(val)) val = `[${val.length} items]`;
          else if (typeof val === 'object' && val !== null) val = '[object]';
          else if (String(val).length > 30) val = String(val).substring(0, 30) + '...';
          lines.push(`<div><strong>${key}:</strong> ${val}</div>`);
        });
      }

      return lines.join('') || '<div><em>No attributes</em></div>';
    }

    function toggleSection(header) {
      const section = header.parentElement;
      section.classList.toggle('expanded');
    }

    function addItem(type) {
      currentEdit = { type, index: null };
      const template = data[type][0] || {};
      const newItem = JSON.parse(JSON.stringify(template));

      if (newItem.attributes?.id !== undefined) {
        const maxId = Math.max(0, ...data[type].map(i => i.attributes?.id || 0));
        newItem.attributes.id = maxId + 1;
      }

      openEditModal(newItem, type, true);
    }

    function editItem(type, idx) {
      currentEdit = { type, index: idx };
      openEditModal(data[type][idx], type, false);
    }

    function deleteItem(type, idx) {
      if (confirm('Are you sure you want to delete this item?')) {
        data[type].splice(idx, 1);
        renderItems(type);
        updateCount(type);
      }
    }

    function openEditModal(item, type, isNew) {
      currentEditData = JSON.parse(JSON.stringify(item));
      document.getElementById('modalTitle').textContent = `${isNew ? 'Add' : 'Edit'} ${type}`;

      // Generate both views
      generateFormView(currentEditData, type);
      generateJsonView(currentEditData);

      // Show form view by default
      switchView('form');

      document.getElementById('editModal').classList.add('active');
    }

    function switchView(view) {
      const formView = document.getElementById('formView');
      const jsonView = document.getElementById('jsonView');
      const buttons = document.querySelectorAll('.view-toggle button');

      if (view === 'form') {
        // Sync JSON to form before switching
        syncJsonToForm();
        formView.classList.add('active');
        jsonView.classList.remove('active');
        buttons[0].classList.add('active');
        buttons[1].classList.remove('active');
      } else {
        // Sync form to JSON before switching
        syncFormToJson();
        formView.classList.remove('active');
        jsonView.classList.add('active');
        buttons[0].classList.remove('active');
        buttons[1].classList.add('active');
      }
    }

    function syncFormToJson() {
      // Collect all form inputs and update currentEditData
      const formInputs = document.querySelectorAll('#formView input[data-path]');
      const formSelects = document.querySelectorAll('#formView select[data-path]');

      // First, collect array items from regular inputs
      const arrays = {};
      formInputs.forEach(input => {
        if (input.dataset.arrayIndex !== undefined) {
          const arrayPath = input.dataset.arrayPath;
          if (!arrays[arrayPath]) {
            arrays[arrayPath] = [];
          }
          const idx = parseInt(input.dataset.arrayIndex);
          let value = input.value;

          // Type conversion
          if (input.type === 'number') {
            value = parseFloat(value);
          } else if (!isNaN(value) && value !== '') {
            value = parseFloat(value);
          }

          arrays[arrayPath][idx] = value;
        }
      });

      // Handle reference selects (for arrays)
      formSelects.forEach(select => {
        if (select.dataset.arrayIndex !== undefined) {
          // This is an array item
          const arrayPath = select.dataset.arrayPath;
          if (!arrays[arrayPath]) {
            arrays[arrayPath] = [];
          }
          const idx = parseInt(select.dataset.arrayIndex);
          let value = select.value ? JSON.parse(select.value) : null;
          arrays[arrayPath][idx] = value;
        }
      });

      // Update arrays in currentEditData
      Object.keys(arrays).forEach(arrayPath => {
        const path = arrayPath.split('[')[0].split('.');
        let obj = currentEditData;

        for (let i = 0; i < path.length - 1; i++) {
          if (!obj[path[i]]) obj[path[i]] = {};
          obj = obj[path[i]];
        }

        const key = path[path.length - 1];
        obj[key] = arrays[arrayPath].filter(v => v !== undefined && v !== null);
      });

      // Handle non-array reference selects (single references)
      formSelects.forEach(select => {
        if (select.dataset.arrayIndex !== undefined) return; // Skip array items

        const path = select.dataset.path.split('[')[0].split('.');
        let obj = currentEditData;

        for (let i = 0; i < path.length - 1; i++) {
          if (!obj[path[i]]) obj[path[i]] = {};
          obj = obj[path[i]];
        }

        const key = path[path.length - 1];
        let value = select.value ? JSON.parse(select.value) : null;
        obj[key] = value;
      });

      // Then handle non-array inputs
      formInputs.forEach(input => {
        if (input.dataset.arrayIndex !== undefined) return; // Skip array items - already processed

        const path = input.dataset.path.split('[')[0].split('.');
        let obj = currentEditData;

        for (let i = 0; i < path.length - 1; i++) {
          if (!obj[path[i]]) obj[path[i]] = {};
          obj = obj[path[i]];
        }

        const key = path[path.length - 1];
        let value = input.value;

        // Type conversion
        if (input.type === 'number') {
          value = parseFloat(value);
        } else if (input.type === 'checkbox') {
          value = input.checked;
        } else if (value === 'true') {
          value = true;
        } else if (value === 'false') {
          value = false;
        } else if (input.dataset.originalType === 'number' && !isNaN(value) && value !== '') {
          value = parseFloat(value);
        }

        obj[key] = value;
      });

      generateJsonView(currentEditData);
    }

    function syncJsonToForm() {
      try {
        const textarea = document.querySelector('#jsonView textarea');
        if (textarea) {
          let jsonText = textarea.value;
          jsonText = jsonText.replace(/:\s*Infinity/g, ': 9007199254740991').replace(/\[\s*Infinity\s*\]/g, '[9007199254740991]');
          currentEditData = JSON.parse(jsonText);
          generateFormView(currentEditData, currentEdit.type);
        }
      } catch (err) {
        alert('Invalid JSON: ' + err.message);
      }
    }

    function parseNestedPath(path, obj) {
      // Parse a path like "attributes.power_model_parameters[0].value" into actual value
      const parts = path.match(/[^.[\]]+/g) || [];
      let current = obj;

      for (let part of parts) {
        if (!isNaN(part)) {
          // Array index
          current = current[parseInt(part)];
        } else {
          current = current[part];
        }

        if (current === undefined || current === null) {
          return null;
        }
      }

      return current;
    }

    function infinityToString(jsonString) {
      // Convert 9007199254740991 back to Infinity in JSON string
      return jsonString.replace(/:\s*9007199254740991([,\n\r]|$)/g, ': Infinity$1').replace(/\[\s*9007199254740991\s*\]/g, '[Infinity]');
    }

    function generateFormView(item, type) {
      const formView = document.getElementById('formView');
      formView.innerHTML = '';

      // Add help text
      const helpText = document.createElement('div');
      helpText.className = 'form-help';
      helpText.innerHTML = 'üí° <strong>Tips:</strong> Simple fields are directly editable. Expandable sections show nested objects. Reference fields let you select existing items. Switch to JSON view for fine-tuning.';
      formView.appendChild(helpText);

      const container = document.createElement('div');
      container.className = 'form-view';

      // Generate form for attributes
      if (item.attributes) {
        const group = document.createElement('div');
        group.className = 'field-group';
        group.innerHTML = '<div class="field-group-title">‚öôÔ∏è Attributes</div>';
        generateFields(item.attributes, 'attributes', group);
        container.appendChild(group);
      }

      // Generate form for relationships
      if (item.relationships) {
        const group = document.createElement('div');
        group.className = 'field-group';
        group.innerHTML = '<div class="field-group-title">üîó Relationships</div>';
        generateFields(item.relationships, 'relationships', group);
        container.appendChild(group);
      }

      // For items without attributes/relationships structure
      if (!item.attributes && !item.relationships) {
        const group = document.createElement('div');
        group.className = 'field-group';
        group.innerHTML = '<div class="field-group-title">üìã Properties</div>';
        generateFields(item, '', group);
        container.appendChild(group);
      }

      formView.appendChild(container);
    }

    function isReference(obj) {
      // Check if object looks like a reference: has 'class' and 'id'
      return obj && typeof obj === 'object' && 'class' in obj && 'id' in obj && Object.keys(obj).length === 2;
    }

    function findItemsByClass(className) {
      // Find all items of a given class in the data
      const results = [];
      if (data[className] && Array.isArray(data[className])) {
        data[className].forEach((item, idx) => {
          const id = item.attributes?.id || item.id || idx;
          const label = item.attributes?.label || item.label || `#${id}`;
          results.push({ class: className, id: id, label: label });
        });
      }
      return results;
    }

    function generateFields(obj, path, container, depth = 0) {
      if (depth > 5) return; // Prevent infinite recursion

      Object.keys(obj).forEach(key => {
        const value = obj[key];
        const fullPath = path ? `${path}.${key}` : key;

        const row = document.createElement('div');
        row.className = 'field-row';

        const label = document.createElement('div');
        label.className = 'field-label';
        label.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        row.appendChild(label);

        const inputContainer = document.createElement('div');

        if (Array.isArray(value)) {
          // Array field
          const arrayDiv = document.createElement('div');
          arrayDiv.className = 'array-field';
          arrayDiv.dataset.arrayPath = fullPath;

          if (value.length === 0) {
            const info = document.createElement('div');
            info.textContent = '(Empty array)';
            info.style.padding = '8px';
            info.style.color = '#9ca3af';
            info.style.fontStyle = 'italic';
            info.style.fontSize = '0.9em';
            arrayDiv.appendChild(info);

            const addBtn = document.createElement('button');
            addBtn.className = 'btn-small btn-add';
            addBtn.textContent = '+ Add Item';
            addBtn.type = 'button';
            addBtn.onclick = () => addArrayItem(arrayDiv, fullPath, null, addBtn);
            arrayDiv.appendChild(addBtn);
          } else if (typeof value[0] === 'object' && value[0] !== null) {
            // Array of objects
            if (isReference(value[0])) {
              // Array of references - store the class for later reference
              arrayDiv.dataset.refClass = value[0].class;

              // Array of references
              value.forEach((item, idx) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'array-item';

                const select = document.createElement('select');
                select.className = 'field-input';
                select.dataset.path = `${fullPath}[${idx}]`;
                select.dataset.arrayIndex = idx;
                select.dataset.arrayPath = fullPath;
                select.dataset.refClass = item.class;

                // Populate options
                const items = findItemsByClass(item.class);
                items.forEach(ref => {
                  const option = document.createElement('option');
                  option.value = JSON.stringify({ class: ref.class, id: ref.id });
                  option.textContent = `${ref.class} #${ref.id}${ref.label !== `#${ref.id}` ? ` (${ref.label})` : ''}`;
                  option.selected = item.id === ref.id && item.class === ref.class;
                  select.appendChild(option);
                });

                itemDiv.appendChild(select);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-small btn-remove';
                removeBtn.textContent = '√ó';
                removeBtn.type = 'button';
                removeBtn.onclick = () => {
                  itemDiv.remove();
                  updateArrayIndices(fullPath);
                };
                itemDiv.appendChild(removeBtn);

                arrayDiv.appendChild(itemDiv);
              });

              const addBtn = document.createElement('button');
              addBtn.className = 'btn-small btn-add';
              addBtn.textContent = '+ Add Reference';
              addBtn.type = 'button';
              addBtn.onclick = () => {
                if (value.length > 0) {
                  addArrayItem(arrayDiv, fullPath, { class: value[0].class, id: null }, addBtn);
                }
              };
              arrayDiv.appendChild(addBtn);
            } else {
              // Array of complex objects
              value.forEach((item, idx) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.border = '1px solid #d1d5db';
                itemDiv.style.borderRadius = '6px';
                itemDiv.style.padding = '12px';
                itemDiv.style.marginBottom = '10px';
                itemDiv.style.backgroundColor = '#f9fafb';

                const itemHeader = document.createElement('div');
                itemHeader.style.display = 'flex';
                itemHeader.style.justifyContent = 'space-between';
                itemHeader.style.alignItems = 'center';
                itemHeader.style.marginBottom = '10px';

                const itemLabel = document.createElement('div');
                itemLabel.style.fontWeight = '500';
                itemLabel.style.color = '#374151';
                itemLabel.textContent = `Item ${idx + 1}`;
                itemHeader.appendChild(itemLabel);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-small btn-remove';
                removeBtn.textContent = '√ó';
                removeBtn.type = 'button';
                removeBtn.onclick = () => {
                  itemDiv.remove();
                  updateArrayIndices(fullPath);
                };
                itemHeader.appendChild(removeBtn);

                itemDiv.appendChild(itemHeader);

                const itemFields = document.createElement('div');
                generateFields(item, `${fullPath}[${idx}]`, itemFields, depth + 1);
                itemDiv.appendChild(itemFields);

                arrayDiv.appendChild(itemDiv);
              });

              const addBtn = document.createElement('button');
              addBtn.className = 'btn-small btn-add';
              addBtn.textContent = '+ Add Item';
              addBtn.type = 'button';
              addBtn.onclick = () => addArrayItem(arrayDiv, fullPath, JSON.parse(JSON.stringify(value[0])), addBtn);
              arrayDiv.appendChild(addBtn);
            }
          } else {
            // Simple array - create inputs
            value.forEach((item, idx) => {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'array-item';

              const input = document.createElement('input');
              input.type = typeof item === 'number' ? 'number' : 'text';
              input.value = item;
              input.className = 'field-input';
              input.dataset.path = `${fullPath}[${idx}]`;
              input.dataset.arrayIndex = idx;
              input.dataset.arrayPath = fullPath;

              itemDiv.appendChild(input);

              const removeBtn = document.createElement('button');
              removeBtn.className = 'btn-small btn-remove';
              removeBtn.textContent = '√ó';
              removeBtn.type = 'button';
              removeBtn.onclick = () => {
                itemDiv.remove();
                updateArrayIndices(fullPath);
              };
              itemDiv.appendChild(removeBtn);

              arrayDiv.appendChild(itemDiv);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'btn-small btn-add';
            addBtn.textContent = '+ Add Item';
            addBtn.type = 'button';
            addBtn.onclick = () => {
              const newIdx = arrayDiv.querySelectorAll('.array-item').length;
              const itemDiv = document.createElement('div');
              itemDiv.className = 'array-item';

              const input = document.createElement('input');
              input.type = typeof value[0] === 'number' ? 'number' : 'text';
              input.value = typeof value[0] === 'number' ? 0 : '';
              input.className = 'field-input';
              input.dataset.path = `${fullPath}[${newIdx}]`;
              input.dataset.arrayIndex = newIdx;
              input.dataset.arrayPath = fullPath;

              itemDiv.appendChild(input);

              const removeBtn = document.createElement('button');
              removeBtn.className = 'btn-small btn-remove';
              removeBtn.textContent = '√ó';
              removeBtn.type = 'button';
              removeBtn.onclick = () => {
                itemDiv.remove();
                updateArrayIndices(fullPath);
              };
              itemDiv.appendChild(removeBtn);

              arrayDiv.insertBefore(itemDiv, addBtn);
            };
            arrayDiv.appendChild(addBtn);
          }

          inputContainer.appendChild(arrayDiv);
        } else if (isReference(value)) {
          // Handle single reference
          const select = document.createElement('select');
          select.className = 'field-input';
          select.dataset.path = fullPath;
          select.dataset.refClass = value.class;

          // Add empty option
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = '-- None --';
          select.appendChild(emptyOption);

          // Populate options
          const items = findItemsByClass(value.class);
          items.forEach(ref => {
            const option = document.createElement('option');
            option.value = JSON.stringify({ class: ref.class, id: ref.id });
            option.textContent = `${ref.class} #${ref.id}${ref.label !== `#${ref.id}` ? ` (${ref.label})` : ''}`;
            option.selected = value.id === ref.id;
            select.appendChild(option);
          });

          inputContainer.appendChild(select);
        } else if (typeof value === 'object' && value !== null) {
          // Nested object - create collapsible section
          const objDiv = document.createElement('div');
          objDiv.style.border = '1px solid #d1d5db';
          objDiv.style.borderRadius = '6px';
          objDiv.style.overflow = 'hidden';
          objDiv.style.backgroundColor = '#f9fafb';

          const objHeader = document.createElement('div');
          objHeader.style.padding = '10px 12px';
          objHeader.style.backgroundColor = '#e9ecef';
          objHeader.style.cursor = 'pointer';
          objHeader.style.display = 'flex';
          objHeader.style.alignItems = 'center';
          objHeader.style.gap = '8px';
          objHeader.style.fontWeight = '500';
          objHeader.style.color = '#374151';
          objHeader.style.userSelect = 'none';

          const toggle = document.createElement('span');
          toggle.textContent = '‚ñ∂';
          toggle.style.display = 'inline-block';
          toggle.style.transition = 'transform 0.2s';
          toggle.style.color = '#667eea';

          objHeader.appendChild(toggle);
          objHeader.appendChild(document.createTextNode(`${Object.keys(value).length} properties`));

          const objBody = document.createElement('div');
          objBody.style.maxHeight = '0';
          objBody.style.overflow = 'hidden';
          objBody.style.transition = 'max-height 0.3s ease-out';
          objBody.style.padding = '0';

          const objContent = document.createElement('div');
          objContent.style.padding = '12px';
          generateFields(value, fullPath, objContent, depth + 1);
          objBody.appendChild(objContent);

          const isExpanded = { value: false };

          objHeader.onclick = () => {
            isExpanded.value = !isExpanded.value;
            if (isExpanded.value) {
              toggle.style.transform = 'rotate(90deg)';
              objBody.style.maxHeight = objBody.scrollHeight + 'px';
            } else {
              toggle.style.transform = 'rotate(0deg)';
              objBody.style.maxHeight = '0';
            }
          };

          objDiv.appendChild(objHeader);
          objDiv.appendChild(objBody);

          inputContainer.appendChild(objDiv);
        } else if (typeof value === 'boolean') {
          // Checkbox for boolean
          const checkboxWrapper = document.createElement('div');
          checkboxWrapper.style.display = 'flex';
          checkboxWrapper.style.alignItems = 'center';
          checkboxWrapper.style.gap = '8px';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = value;
          input.dataset.path = fullPath;
          input.style.width = '20px';
          input.style.height = '20px';
          input.style.cursor = 'pointer';

          const valueLabel = document.createElement('span');
          valueLabel.textContent = value ? 'true' : 'false';
          valueLabel.style.color = '#6b7280';
          valueLabel.style.fontSize = '0.9em';

          input.onchange = () => {
            valueLabel.textContent = input.checked ? 'true' : 'false';
          };

          checkboxWrapper.appendChild(input);
          checkboxWrapper.appendChild(valueLabel);
          inputContainer.appendChild(checkboxWrapper);
        } else {
          // Simple input
          const input = document.createElement('input');
          input.type = typeof value === 'number' ? 'number' : 'text';
          input.value = value === null ? '' : value;
          input.className = 'field-input';
          input.dataset.path = fullPath;
          input.dataset.originalType = typeof value;

          if (typeof value === 'number') {
            input.step = 'any';
          }

          inputContainer.appendChild(input);
        }

        row.appendChild(inputContainer);
        container.appendChild(row);
      });
    }

    function addArrayItem(container, arrayPath, template, addBtn) {
      const newIdx = container.querySelectorAll('[data-array-path="' + arrayPath + '"]').length;
      const itemDiv = document.createElement('div');

      // If template is null, try to infer the reference class from stored data
      let effectiveTemplate = template;
      if (!template && container.dataset.refClass) {
        effectiveTemplate = { class: container.dataset.refClass, id: null };
      }
      if (!template && !effectiveTemplate) {
        // Look at data structure to determine what to add
        const currentData = parseNestedPath(arrayPath, data);
        if (Array.isArray(currentData) && currentData.length > 0 && isReference(currentData[0])) {
          effectiveTemplate = { class: currentData[0].class, id: null };
        }
      }

      if (effectiveTemplate && effectiveTemplate.class) {
        // Reference item
        itemDiv.className = 'array-item';

        const select = document.createElement('select');
        select.className = 'field-input';
        select.dataset.path = `${arrayPath}[${newIdx}]`;
        select.dataset.arrayIndex = newIdx;
        select.dataset.arrayPath = arrayPath;
        select.dataset.refClass = effectiveTemplate.class;

        // Add empty option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Select --';
        select.appendChild(emptyOption);

        const items = findItemsByClass(effectiveTemplate.class);
        items.forEach(ref => {
          const option = document.createElement('option');
          option.value = JSON.stringify({ class: ref.class, id: ref.id });
          option.textContent = `${ref.class} #${ref.id}${ref.label !== `#${ref.id}` ? ` (${ref.label})` : ''}`;
          select.appendChild(option);
        });

        itemDiv.appendChild(select);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn-small btn-remove';
        removeBtn.textContent = '√ó';
        removeBtn.type = 'button';
        removeBtn.onclick = () => {
          itemDiv.remove();
          updateArrayIndices(arrayPath);
        };
        itemDiv.appendChild(removeBtn);
      } else if (effectiveTemplate && typeof effectiveTemplate === 'object') {
        // Complex object item
        itemDiv.style.border = '1px solid #d1d5db';
        itemDiv.style.borderRadius = '6px';
        itemDiv.style.padding = '12px';
        itemDiv.style.marginBottom = '10px';
        itemDiv.style.backgroundColor = '#f9fafb';

        const itemHeader = document.createElement('div');
        itemHeader.style.display = 'flex';
        itemHeader.style.justifyContent = 'space-between';
        itemHeader.style.alignItems = 'center';
        itemHeader.style.marginBottom = '10px';

        const itemLabel = document.createElement('div');
        itemLabel.style.fontWeight = '500';
        itemLabel.style.color = '#374151';
        itemLabel.textContent = `Item ${newIdx + 1}`;
        itemHeader.appendChild(itemLabel);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn-small btn-remove';
        removeBtn.textContent = '√ó';
        removeBtn.type = 'button';
        removeBtn.onclick = () => {
          itemDiv.remove();
          updateArrayIndices(arrayPath);
        };
        itemHeader.appendChild(removeBtn);

        itemDiv.appendChild(itemHeader);

        const itemFields = document.createElement('div');
        generateFields(template, `${arrayPath}[${newIdx}]`, itemFields, 1);
        itemDiv.appendChild(itemFields);
      }

      container.insertBefore(itemDiv, addBtn);
    }

    function updateArrayIndices(arrayPath) {
      const inputs = document.querySelectorAll(`[data-array-path="${arrayPath}"]`);
      inputs.forEach((input, idx) => {
        input.dataset.arrayIndex = idx;
        input.dataset.path = `${arrayPath}[${idx}]`;
      });
    }

    function generateJsonView(item) {
      const jsonView = document.getElementById('jsonView');
      jsonView.innerHTML = '';

      // Add help text
      const helpText = document.createElement('div');
      helpText.className = 'form-help';
      helpText.innerHTML = 'üí° <strong>Tip:</strong> Advanced editing mode. Edit the raw JSON structure directly.';
      jsonView.appendChild(helpText);

      const form = document.createElement('form');
      form.id = 'jsonForm';

      const textarea = document.createElement('textarea');
      textarea.className = 'form-control';
      textarea.style.minHeight = '400px';
      textarea.value = infinityToString(JSON.stringify(item, null, 2));

      const group = document.createElement('div');
      group.className = 'form-group';
      const label = document.createElement('label');
      label.textContent = 'JSON Data';
      group.appendChild(label);
      group.appendChild(textarea);
      form.appendChild(group);

      jsonView.appendChild(form);
    }

    function closeModal() {
      document.getElementById('editModal').classList.remove('active');
      currentEdit = { type: null, index: null };
      currentEditData = null;
    }

    function saveItem() {
      try {
        // Get data from whichever view is active
        const activeView = document.querySelector('.view-container.active');

        if (activeView.id === 'jsonView') {
          const textarea = activeView.querySelector('textarea');
          let jsonText = textarea.value;
          jsonText = jsonText.replace(/:\s*Infinity/g, ': 9007199254740991').replace(/\[\s*Infinity\s*\]/g, '[9007199254740991]');
          currentEditData = JSON.parse(jsonText);
        } else {
          syncFormToJson();
        }

        if (currentEdit.index !== null) {
          data[currentEdit.type][currentEdit.index] = currentEditData;
        } else {
          data[currentEdit.type].push(currentEditData);
        }

        renderItems(currentEdit.type);
        updateCount(currentEdit.type);
        closeModal();
      } catch (err) {
        alert('Invalid data: ' + err.message);
      }
    }

    function updateCount(type) {
      const section = document.querySelector(`[data-type="${type}"] .section-count`);
      if (section) {
        section.textContent = `${data[type].length} items`;
      }
    }

    function downloadJSON() {
      const jsonString = infinityToString(JSON.stringify(data, null, 2));
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'edgesimpy-scenario.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Click outside modal to close
    document.getElementById('editModal').addEventListener('click', e => {
      if (e.target.id === 'editModal') {
        closeModal();
      }
    });
  </script>
</body>

</html>